{% extends "base.html" %}
{% load tz %}
{% block title %}Chat{% endblock %}

{% block content %}

<a href="{% url 'message-inbox' %}" class="text-decoration-none text-muted mb-3 d-inline-block">
    ‚Üê Back to Messages
</a>

<h3 class="fw-semibold mb-4">
    Chat with
    {% if conversation.user1 == user %}
        {{ conversation.user2.username }}
    {% else %}
        {{ conversation.user1.username }}
    {% endif %}
</h3>

<div id="message-container"
     class="figma-card p-4 mb-4"
     style="height: 300px; overflow-y: auto;">

    {% for m in messaging %}
        <div class="d-flex mb-3 {% if m.sender == user %}justify-content-end{% endif %}">
            <div class="{% if m.sender == user %}bg-primary text-white{% else %}bg-light{% endif %} p-2 rounded"
                 style="max-width: 70%;">

                <div>{{ m.text }}</div>

                <div class="text-muted small mt-1" style="font-size: 0.75rem;">
                    {{ m.timestamp|localtime|date:"M j, g:i A" }}
                </div>
            </div>
        </div>
    {% empty %}
        <p class="text-muted">No messages yet. Say hi üëã</p>
    {% endfor %}
</div>

<form method="POST">
    {% csrf_token %}
    <textarea name="text"
              id="chat-input"
              class="figma-input w-100 mb-2"
              rows="2"
              placeholder="Type a message..."
              required></textarea>
    <button class="figma-add-btn w-100">Send</button>
</form>

<script>
    const msgBox = document.getElementById("message-container");
    msgBox.scrollTop = msgBox.scrollHeight;

    document.getElementById("chat-input").addEventListener("keydown", function(e) {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            this.form.submit();
        }
    });
</script>

{% endblock %}